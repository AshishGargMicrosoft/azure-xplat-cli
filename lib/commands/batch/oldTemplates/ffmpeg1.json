{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "accountName": {
      "type": "string",
      "metadata": {
        "description": "The name of batch account"
      }
    },
    "inputFileStorageUrl": {
      "type": "string",
      "metadata": {
        "description": "The url of Azure storage blob which the processing file located",
        "ncjDirectory": "SingleFile.fullurl"
      }
    },
    "outputFileStorageUrl": {
      "type": "string",
      "metadata": {
        "description": "The url of Azure storage container which hold the output file",
        "ncjDirectory": "ResourceFolder.fullurl"
      }
    },    
    "vmSize": {
        "type": "string",
        "metadata": {
            "description": "The size of the virtual machines that runs the application"
        },
        "defaultValue": "STANDARD_D1",
        "allowedValues": [
            "STANDARD_A1",
            "STANDARD_A2",
            "STANDARD_A3",
            "STANDARD_A4",
            "STANDARD_D1",
            "STANDARD_D2",
            "STANDARD_D3",
            "STANDARD_D4"
        ]
    },
    "vmCount": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "The number of the virtual machines"
      }
    },
    "poolName": {
      "type": "string",
      "defaultValue": "ffmpegpool",
      "metadata": {
        "description": "The name of Azure Batch pool which runs the job"
      }
    },
    "jobName": {
      "type": "string",
      "metadata": {
        "description": "The name of Azure Batch job"
      }
    }    
  },
  "variables": {
    "accountBase": "[concat('Microsoft.Batch/batchAccounts/', parameters('accountName'))]",
    "osType": {
      "publisher": "Canonical",
      "offer": "UbuntuServer",
      "sku": "15.10",
      "version": "latest"
    }    
  },
  "resources": [
    {
      "type": "Microsoft.Batch/batchAccounts/software",
      "apiVersion": "2016-12-01",
      "name": "[concat(parameters('accountName'), '/ffmpeg')]",
      "resources": [
        {
          "type": "versions",
          "apiVersion": "2016-12-01",
          "name": "1.0",
          "properties":{
            "binarySourceType": "None",
            "installCmd": "apt-get install ffmpeg",
            "reboot": false,
            "runAsAdmin": true
          }
        }
      ]
    },
    {
      "type": "Microsoft.Batch/batchAccounts/pools",
      "apiVersion": "2016-12-01",
      "name": "[concat(parameters('accountName'), '/', parameters('poolName'))]",
      "dependsOn": [
        "[concat(variables('accountBase'), '/software/ffmpeg/versions/1.0')]"
      ],
      "properties": {
        "virtualMachineConfiguration": {
          "imageReference": "[variables('osType')]",
          "nodeAgentSKUId": "batch.node.debian 8"
        },
        "vmSize": "[parameters('vmSize')]",
        "vmCount": "[parameters('vmCount')]",
        "enableAutoScale": false
      }
    },
    {
      "type": "Microsoft.Batch/batchAccounts/jobs",
      "apiVersion": "2016-12-01",
      "name": "[concat(parameters('accountName'), '/', parameters('jobName'))]",
      "dependsOn": [
        "[concat(variables('accountBase'), '/pools/', parameters('poolName'))]"
      ],
      "properties": {
        "constraints": {
          "maxWallClockTime": "PT5H",
          "maxTaskRetryCount": 3
        },
        "poolInfo": {
          "poolId": "[parameters('poolName')]"
        },
        "softwareReferences": [
          "ffmpeg/1.0"
        ],
        "taskFactories": [
          {
            "type": "regular",
            "properties": {
              "tasks": [
                {
                  "cmdLine": "ffmpeg.exe -i single.wav -acodec mp3 -ab 192k output.mp3",
                  "resourceFiles": [
                    {
                      "path": "single.wav",
                      "source": "[parameters('inputFileStorageUrl')]" 
                    }
                  ],
                  "outputFiles": [
                    {
                      "filePath": "output.mp3",
                      "containerDestination": "[parameters('outputFileStorageUrl')]",
                      "format": "Raw",
                      "uploadMode": "TaskCompletion" 
                    }
                  ]
                }
              ] 
            }
          }
        ]
      }
    }
  ]
}